<!-- Styles -->
<style>
  #chartdiv {
    width: 100%;
    height: 500px;
  }
</style>

<!-- Resources -->
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/continentsLow.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

<!-- Chart code -->
<script>
  am5.ready(function () {
    var root = am5.Root.new('chartdiv')
    root.setThemes([am5themes_Animated.new(root)])

    var map = createMap(root)
    var pointSeries = createPointSeries(root, map)
    var colorSet = am5.ColorSet.new(root, { step: 2 })

    setupMapEvents(map, pointSeries)
    addDataToSeries(pointSeries)

    map.appear(1000, 100)

    // Function to create the map
    function createMap(root) {
      return root.container.children.push(
        am5map.MapChart.new(root, {
          panX: 'none',
          projection: am5map.geoNaturalEarth1(),
        })
      )
    }

    // Function to create point series
    function createPointSeries(root, map) {
      var polygonSeries = map.series.push(
        am5map.MapPolygonSeries.new(root, {
          geoJSON: am5geodata_continentsLow,
          exclude: ['antarctica'],
          fill: am5.color(0xbbbbbb),
          toggleKey: 'active',
          interactive: true,
        })
      )

      var pointSeries = map.series.push(am5map.MapPointSeries.new(root, {}))
      pointSeries.bullets.push(function (root, series, dataItem) {
        return createBullet(root, map, dataItem, colorSet)
      })

      return pointSeries
    }

    // Function to setup map events
    function setupMapEvents(map, pointSeries) {
      map.chartContainer.get('background').events.on('click', function () {
        var infoBox = document.getElementById('infoBox')
        if (infoBox) {
          infoBox.remove()
        }
        map.goHome()
        pointSeries.show()
      })
    }

    // Function to add data to point series
    function addDataToSeries(pointSeries) {
      var data = [
        {
          title: 'United States',
          name: 'United States',
          latitude: 39.563353,
          longitude: -99.316406,
          width: 100,
          height: 100,
          value: 12,
        },
        {
          title: 'European Union',
          name: 'European Union',
          latitude: 50.896104,
          longitude: 19.160156,
          width: 50,
          height: 50,
          value: 15,
        },
        {
          title: 'Asia',
          name: 'Asia',
          latitude: 47.212106,
          longitude: 103.183594,
          width: 80,
          height: 80,
          value: 8,
        },
        {
          title: 'Africa',
          name: 'Africa',
          latitude: 11.081385,
          longitude: 21.621094,
          width: 50,
          height: 50,
          value: 5,
        },
      ]

      data.forEach(function (d) {
        pointSeries.data.push({
          geometry: { type: 'Point', coordinates: [d.longitude, d.latitude] },
          title: d.title,
          value: d.value,
        })
      })
    }

    // Function to create bullets
    function createBullet(root, map, dataItem, colorSet) {
      var value = dataItem.dataContext.value
      var coordinates = dataItem.dataContext.geometry.coordinates
      var title = dataItem.dataContext.title

      var container = am5.Container.new(root, {})
      var color = colorSet.next()
      var radius = 15 + (value / 20) * 20

      var circle = container.children.push(
        am5.Circle.new(root, {
          radius: radius,
          fill: color,
          dy: -radius * 2,
          cursorOverStyle: 'pointer',
        })
      )

      circle.events.on('click', function () {
        map.zoomToGeoPoint(
          { longitude: coordinates[0], latitude: coordinates[1] },
          3,
          true,
          1500
        )
        createInfoBox(title, value)
      })

      container.children.push(
        am5.Line.new(root, {
          stroke: color,
          height: -40,
        })
      )

      container.children.push(
        am5.Label.new(root, {
          text: value + '%',
          fill: am5.color(0xffffff),
          fontWeight: '400',
          centerX: am5.p50,
          centerY: am5.p50,
          dy: -radius * 2,
        })
      )

      container.children.push(
        am5.Label.new(root, {
          text: dataItem.dataContext.title,
          fill: color,
          fontWeight: '500',
          fontSize: '1em',
          centerY: am5.p50,
          dy: -radius * 2,
          dx: radius,
        })
      )

      return am5.Bullet.new(root, {
        sprite: container,
      })
    }

    // Function to create info box
    function createInfoBox(title, value) {
      var existingInfoBox = document.getElementById('infoBox')
      if (existingInfoBox) {
        existingInfoBox.remove()
      }

      var fragment = document.createDocumentFragment()
      var infoBox = document.createElement('div')
      infoBox.id = 'infoBox'
      infoBox.style.position = 'absolute'
      infoBox.style.left = '10px'
      infoBox.style.top = '10px'
      infoBox.style.padding = '10px'
      infoBox.style.background = 'white'
      infoBox.style.border = '1px solid black'
      infoBox.style.borderRadius = '5px'
      infoBox.innerHTML =
        '<strong>' + title + '</strong><br>' + value + '% of something'

      fragment.appendChild(infoBox)
      document.body.appendChild(fragment)
    }
  }) // end am5.ready()
</script>

<!-- HTML -->
<div id="chartdiv"></div>
